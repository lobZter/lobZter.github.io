<h5 id="Model-free-Energy-based-Off-policy-Continuous-State-Space-Continuous-Action-Space"><a href="#Model-free-Energy-based-Off-policy-Continuous-State-Space-Continuous-Action-Space" class="headerlink" title="Model-free, Energy-based, Off-policy, Continuous State Space, Continuous Action Space"></a>Model-free, Energy-based, Off-policy, Continuous State Space, Continuous Action Space</h5><p>最優的策略不僅是最大化所有累積獎勵，同時策略要夠隨機。換句話說在每個狀態下採取的行為的熵比較大。<br>優點是更易於探索及讓在不同任務中轉移學到技巧，可用在訓練的初始化。例如先讓機器人學如何前進當作初始化，學習所有前進的動作，再分別學習跑步或跳躍等動作。</p>
<p>傳統強化學習的目標為：<br>$$\pi_\text{std}^\ast=\arg\max_\pi \sum_t\mathbb{E}_{(s_t,a_t)\sim\rho_\pi}[r(s_t,a_t)]$$</p>
<p>最大熵的強化學習再後面加上了的熵項：<br>$$\pi_\text{MaxEnt}^\ast=\arg\max_\pi \sum_t\mathbb{E}_{(s_t,a_t)\sim\rho_\pi}[r(s_t,a_t)+<br>\alpha\mathcal{H}(\pi(\cdot|s_t))]$$</p>
<p>許多算法里面策略用的是 discrete multinomial distributions 或者 Gaussian distributions，這些的分布只能表示 unimodal 分布形式，這樣最後收斂的结果基本上是確定性的，沒辦法得到隨機性模型。要想表示 multi-modal 多峰的分布作者採用以energy-based 模型來實現：<br>$$\pi(a_t|s_t) \propto \exp(-\mathbb{E}(s_t, a_t))$$</p>
<p>其中 $\mathcal{E}$ 就是能量函數 (energy function)，可以用深度神經網路來建模</p>
<p>論文中，作者將個 energy function 與 soft value function 和 soft Q function 结合起来，定義出<br>$$\mathcal{E}(s_t,a_t)=-\frac{1}{\alpha}Q_{soft}(s_t,a_t)$$</p>
<p>soft Q-function 定義為：<br>$$Q_{soft}^\ast(s_t,a_t)=r_t+\mathbb{E}_{(s_{t+1,\cdots\ \ \ })\sim\rho_\pi}\left[ \sum_{l=1}^\infty \gamma^l(r_{t+l}+<br>\alpha\mathcal{H}(\pi_{\text{MaxEnt}}^\ast(\cdot|s_{t+l}))) \right]$$</p>
<p>最優策略為：<br>$$<br>\begin{align*}<br>\pi_\text{MaxEnt}^\ast(a_t|s_t)&amp;=\exp\left(\frac{1}{\alpha}(Q_{soft}^\ast(s_t,a_t)-V_{soft}^\ast(s_t))\right)\\<br>&amp;= \frac{\exp\left(\frac{1}{\alpha}Q_{soft}^\ast(s_t,a_t)\right)}{\int_\mathcal{A} \exp\left( \frac{1}{\alpha}Q_{soft}^\ast(s_t,a’) \right) \mathrm{d}a’}\\<br>&amp;=\frac{\exp\left(\frac{1}{\alpha}Q_{soft}^\ast(s_t,a_t)\right)}{\exp\left(\frac{1}{\alpha}V_{soft}^\ast(s_t)\right)}<br>\end{align*}<br>$$</p>
<p>可以看出，V函數相當於是對Q函數的 softmax 操作，在 energy-based 的表示裡面，V相當於是 partition function 配分函數（指數表示下的歸一化因子）</p>
<h2 id="Soft-Q-Learning"><a href="#Soft-Q-Learning" class="headerlink" title="Soft Q-Learning"></a>Soft Q-Learning</h2><h3 id="Soft-Q-Iteration"><a href="#Soft-Q-Iteration" class="headerlink" title="Soft Q-Iteration"></a>Soft Q-Iteration</h3><p>求解最佳 soft Q-function $Q_{soft}^\ast(s_t,a_t)$ 可以用迭代的方法求解：<br>$$Q_{soft}(s_t, a_t) ← r_t + \gamma\ \mathcal{E}_{s_{t+1}\ \sim\ p_s}\left[V_{soft}(s_{t+1})\right]$$</p>
<p>$$V_{soft}(s_t) ← \alpha\ \mathrm\log\int_\mathcal{A}\mathrm\exp\left(\frac{1}{\alpha}Q_{soft}(s_t, a’)\right)\mathrm{d}a’, \forall s_t$$</p>
<p>但現實面有幾點問題：<br>-soft Bellman backup 没辦法實現在連續的空間上<br>-沒辦法直接對結合能量函數的策略採樣行為 $\pi_\text{MaxEnt}^\ast(a_t|s_t) = \exp\left(\frac{1}{\alpha}(Q_{soft}^\ast(s_t,a_t)-V_{soft}^\ast(s_t))\right)$</p>
<h3 id="Soft-Q-Learning-1"><a href="#Soft-Q-Learning-1" class="headerlink" title="Soft Q-Learning"></a>Soft Q-Learning</h3><p>soft value function 式子里面有對於整個行為空間的積分，在連續空間裡面不可能精確求解，作者用重要性採樣的方法來估計：<br>$$V^\theta_{soft}(s_t) = \alpha\ \log\ \mathbb{E}_{q_{a’}}\left[ \frac{\exp\left(\frac{1}{\alpha}\ Q^\theta_{soft}\ \ (s_t,\ a’)\right)}{q_{a’}(a’)}\right] ,\ (10)$$</p>
<p>用值函數近似 – 最小化近似值函數與真實值函數之間的最小均方誤差來估計 $\theta$ 為參數的 soft Q-function，損失函數為：<br>$$J_Q(\theta)=\mathbb{E}_{s_t\sim q_{s_t},a_t\sim q_{a_t}}\left[\frac{1}{2}\left( \hat{Q}_{soft}^\bar{\theta}(s_t,a_t)-Q_{soft}^\theta(s_t,a_t) \right)^2\right],\ (11)$$</p>
<p>$\hat{Q}_{soft}^\bar{\theta}(s_t,a_t)$ 為 target Q-value，需設置兩個參數網路 $\theta$ 及 $\bar\theta$</p>
<p>其中 $q_{a’}$ 可以为任意的行為概率分布，偷懶可以使用uniform distribution但不易擴展到高維空間，作者採用當前行為的概率分布</p>
<p>為了採樣當前的行為概率分布，仍需要一個可實現的方法對策略 $\pi(a_t|s_t) \propto \exp\left(\frac{1}{\alpha}(Q_{soft}^\ast(s_t,a_t))\right)$ 進行採樣</p>
<h3 id="Approximate-Sampling-and-Stein-Variational-Gradient-Descent-SVGD"><a href="#Approximate-Sampling-and-Stein-Variational-Gradient-Descent-SVGD" class="headerlink" title="Approximate Sampling and Stein Variational Gradient Descent (SVGD)"></a>Approximate Sampling and Stein Variational Gradient Descent (SVGD)</h3><p>即使有了 soft value function 和 soft q function 的迭代公式，也知道了策略的表示形式 $\pi_\text{MaxEnt}^\ast(a_t|s_t) = \exp\left(\frac{1}{\alpha}(Q_{soft}^\ast(s_t,a_t)-V_{soft}^\ast(s_t))\right)$，但由於這個策略行為分布太過複雜，給定一個狀態 $s_t$ 時，我們無法根據的這策略得到一個行為</p>
<p>目前有許多方法可以對 energy-based distribution 進行採樣，例如 Markov chain Monte Carlo (MCMC) 法，或是學一個學隨機的採樣網路近似目標分布來進行採樣。</p>
<p>因為用 MCMC 法需要在線的執行策略，不太可行，作者這邊採用基於 SVGD 和 amortized SVGD 的採樣網路。amortized SVGD 有許多優點：<br>-提供了一個隨機的採樣網路，所以採樣非常有效率<br>-最終會收斂到 energy-based model 的後驗分布上<br>-非常類似 actor-critic 的算法</p>
<p>作者設計一個行為採樣網路$a_t = f^\phi(\xi;s_t)$，$\phi$ 參數網路以狀態 $s_t$ 為條件，將從高斯分布或其他任意分布而来的噪聲採樣映射到無偏差的行為採樣。</p>
<p>把這個行為策略分布以 $\pi^\phi(a_t|s_t)$ 表示，目標是找到參數 $\phi$ 使得這個估計的策略分布與真實的 energy-based distribution 策略的KL散度最小：<br>$$J_\pi(\phi;s_t)=D_{KL}\left( \pi^\phi(\cdot|s_t)\bigg|\exp\left(\frac{1}{\alpha}(Q_{soft}^\theta(s_t,\cdot)-V_{soft}^\theta)\right) \right),\ (12)$$</p>
<p>使用 SVGD 損失函數的梯度進行求解：<br>$$\Delta f=\mathbb{E}_{a_t\sim\pi^\phi}\Big[\kappa(a_t,f)\nabla_{a’}Q_{soft}^\theta(s_t,a’)|_{a’=a_t}+\alpha\nabla_{a’}\kappa(a’,f)|_{a’=a_t}\Big],\ (13) $$</p>
<p>其中 $\kappa$ 為核函數（可為高斯核函數），照 Wang and Liu. SVGD 論文中的說法，$\Delta f^\phi$ 是在 $\kappa$ 的 Reproducing Kernel Hilbert Space 中的最佳更新方向，所以沒有嚴格說是 $J_\pi$ 的梯度，可以得出 $\frac{\partial J_\pi}{\partial a_t} \propto \Delta f^\phi$。</p>
<p>根據 chain rule 上述假設，得到更新策略網路的梯度：<br>$$\frac{\partial J_\pi(\phi;s_t)}{\partial\phi} \propto \mathbb{E}_\xi\left[ \Delta f^\phi(\xi;s_t)\frac{\partial f^\phi(\xi;s_t)}{\partial\phi} \right] ,\ (14) $$</p>
<p>採樣網路 $f^\phi$ 可以看成是 actor-critic 中的 actor</p>
<h3 id="Algorithm"><a href="#Algorithm" class="headerlink" title="Algorithm"></a>Algorithm</h3><p>$\theta$, $\phi \sim$ some initialization distributions.<br>Assign target parameters: $\bar{\theta} ← \theta$, $\bar{\phi} ← \phi$.<br>$D$ $←$ empty replay memory.<br><strong>for each</strong> epoch <strong>do</strong><br>&ensp;&ensp;<strong>for each</strong> t <strong>do</strong><br>&ensp;&ensp;&ensp;&ensp;<strong>Collect experience</strong><br>&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;Sample an action for $s_t$ using $f^\phi$:<br>&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;$a_t ← f_\phi (\xi; s_t)$ where $\xi \sim N (0, I)$.<br>&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;Sample next state $s_{t+1}$ from the environment:<br>&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;$s_{t+1} \sim p_s(s_{t+1}|s_t, a_t)$.<br>&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;Save the new experience in the replay memory:<br>&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;$D ← D ∪ {(s_t, a_t, r(s_t, a_t), s_{t+1})}$.<br>&ensp;&ensp;&ensp;&ensp;<strong>Sample a minibatch from the replay memory</strong><br>&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;${(s^{(i)}_t, a^{(i)}_t, r^{(i)}_t, s^{(i)}_{t+1}}^N_{i=0} \sim D$.<br>&ensp;&ensp;&ensp;&ensp;<strong>Update the soft Q-function parameters</strong><br>&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;Sample ${a(i,j)}^M_{j=0} \sim q_{a’}$ for each $s^{(i)}_{t+1}$.<br>&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;Compute empirical soft values $\hat{V}^{\bar{\theta}}_{soft}(s^{(i)}_{t+1})$ in (10).<br>&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;Compute empirical gradient $\hat{\nabla}_\theta J_Q$ of (11).<br>&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;Update $\theta$ according to $\hat{\nabla}_\theta J_Q$ using ADAM.<br>&ensp;&ensp;&ensp;&ensp;<strong>Update policy</strong><br>&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;Sample ${\xi^{(i,j)}}^M_{j=0} \sim N (0, I)$ for each $s^{(i)}_t$.<br>&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;Compute actions $a(i,j)_t = f_\phi(\xi^{(i,j)}, s^{(i)}_t)$.<br>&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;Compute $\Delta f^\phi$ using empirical estimate of (13).<br>&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;Compute empiricial estimate of (14): $\hat{\nabla}_\phi J_\pi$.<br>&ensp;&ensp;&ensp;&ensp;&ensp;&ensp;Update $\phi$ according to $\hat{\nabla}_\phi J_\pi$ using ADAM.<br>&ensp;&ensp;<strong>end for</strong><br>&ensp;&ensp;<strong>if</strong> epoch mod update interval = 0 <strong>then</strong><br>&ensp;&ensp;&ensp;&ensp;Update target parameters: $\bar\theta ← \theta$, $\bar\phi ← \phi$.<br>&ensp;&ensp;<strong>end if</strong><br><strong>end for</strong></p>
<h2 id="Refence"><a href="#Refence" class="headerlink" title="Refence"></a>Refence</h2><p><a href="https://zhuanlan.zhihu.com/p/44783057" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/44783057</a><br><a href="https://bluefisher.github.io/2018/11/13/Reinforcement-Learning-with-Deep-Energy-Based-Policies/" target="_blank" rel="noopener">https://bluefisher.github.io/2018/11/13/Reinforcement-Learning-with-Deep-Energy-Based-Policies/</a></p>
